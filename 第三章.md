## 第三章 数据链路层

数据链路层使用的信道主要有以下两种类型：
- 点对点信道。这种信道使用一对一的点对点通信方式。
- 广播信道。这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。 

### 3.1 物理层的基本概念

1. 链路 (link) 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。<mark>一条链路只是一条通路的一个组成部分。</mark>
2. 数据链路 (data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能。   
3. 数据链路层传送的是帧，结点A网络层的IP数据报装入数据链路层的中的帧后在物理层转为01编码开始在传输媒体中传送。到达结点B后经过处理再从帧中取出IP数据报。<u>链路层不必考虑物理层是如何实现比特传输的细节</u>
4. 封装成帧 (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。添加的首、尾部就是为了确定帧的界限。常用的帧定界方法是用控制字符。见下一条。
5. 当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。控制字符 SOH (Start Of Header) 放在一帧的最前面，表示帧的首部开始。另一个控制字符 EOT (End Of Transmission) 表示帧的结束。但是这只是针对传输的数据为ASCII码时，如果要传输的数据中国年某个字节的二进制代码恰好与SOH EOT相同，有可能导致帧被提前结束。于是就涉及到了透明传输的问题，见下一条。
6. 透明传输：当传送的帧是键盘输入的ASCII码时，SOH EOT采用特殊字符，这样不管键盘上输入什么都可以放在这样的帧中传输过去，这样的传输就是透明传输。如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”，这也就不再是透明传输。解决方法：字节填充 (byte stuffing) 或字符填充 (character stuffing)。
    - <u>发送端</u>的<u>数据链路层</u>在数据中出现控制字符“SOH”或“EOT”的前面<u>插入</u>一个转义字符“ESC” (其十六进制编码是 1B)。
    - <u>接收端</u>的<u>数据链路层</u>在<u>将数据送往网络层之前</u>删除插入的转义字符。
    - 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。
7. 差错检测：在传输过程中可能会产生比特差错：1 可能会变成 0 而 0 也可能变成 1。在数据链路层传送的帧中，广泛使用了循环冗余检验 CRC 的检错技术。CRC算法的细节我删除了，就留下下面两句。CRC的复习应根据习题来。去看书后<font size=4 color=tomato>【=习题3-07=】一定会考可能是原题可能是变形，关键是mod2 相同为0不同为1</font>
    - 将余数 R 作为冗余码拼接在数据 M 后面发送出去。
    - 收到数据后使用相同的除数，余数为零则代表无差错。
8. 帧检验序列就是在数据后面添加的冗余码。称为FCS（Frame Check Sequence）。FCS可由CRC得出但并非只能用CRC得出
9. <mark>仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受 (accept)。</mark>“无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错”。也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）。<mark>要做到“可靠传输”（即发送什么就收到什么）就必须再加上确认和重传机制。  </mark>
10. <mark>“无比特差错”与“无传输差错”是不同的概念。</mark>在数据链路层使用<u> CRC 检验，能够实现无比特差错的传输，但这还不是可靠传输。</u>
<strong><u>本章介绍的数据链路层协议都不是可靠传输的协议。</u></strong>
11. 目前互联网采用区别对待的方法，对于通信质量良好的有线传输链路，数据链路层不使用确认和重传机制，出现差错要改的时候由运输层的TCP协议等来完成。而对于通信质量较差的无线传输链路，数据链路层协议使用确认和重传机制，数据链路层向上提供可靠传输的服务。

### 3.2  点对点协议 PPP

我们知道，<mark><u>互联网用户通常需要连接到某个ISP才能接入网络，PPP协议（point-to-point protocol）就是用户计算机与ISP进行通信时所使用的数据链路层协议。PPP是目前使用得最广泛的数据链路层协议</u></mark>

0. PPP 协议有三个组成部分：
    - 一个将 IP 数据报封装到串行链路的方法。
    - 链路控制协议 LCP (Link Control Protocol)。
    - 网络控制协议 NCP (Network Control Protocol)。

1. PPP 协议的帧格式
    - <mark>PPP 帧的首部和尾部分别为 4 个字段和 2 个字段</mark>。
    - 其中首部的第一个字段和尾部的第二个字段都是标志字段F（Flag），F=0x7E（即16进制的7E，01111110-8bit）标志字段表示一个帧的开始或结束。因此标志字段就是PPP帧的定界符。连续两帧之间<mark><u>只需要</u></mark>用一个标志字段。如果出现连续两个标志字段，就表示这是一个空帧，果断丢弃。

    </mark> <font size=6 color=tomato>【==PPP帧格式中先后顺序牢记-掌握-熟练==】</font>
    
    ```
     PPP帧的格式：| F      A   C    协议    【首部，4个字段】| 信息部分（IP数据报）【不超过1500字节，可变长度】| FCS      F   【尾部，2个字段】|
      详细格式：  |0x7E  0xFF 0x03 2BYTE  【首部，5BYTE】  | 信息部分（IP数据报）【不超过1500字节，可变长度】| 2BYTE   0x7E 【尾部，3BYTE】 |
    ```

    - 地址字段 A 只置为 0xFF。<u>地址字段实际上并不起作用</u>。控制字段 C 通常置为 0x03。
    - PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。
    - <mark>PPP 有一个 2 个字节的协议字段。其值</mark> <font size=6 color=tomato>【==识记部分==】</font>
        - 若为 0x0021，则信息字段就是 IP 数据报。
        - 若为 0x8021，则信息字段是网络控制数据。
        - 若为 0xC021，则信息字段是 PPP 链路控制数据。
        - 若为 0xC023，则信息字段是鉴别数据。
    - 当 PPP 用在同步传输链路时（一连串比特连续传送），协议规定采用硬件来完成比特填充（和 HDLC（高级数据链路控制）的做法一样）。当 PPP 用在异步传输时（逐个比特传送），就使用一种特殊的字符填充法。 
    - 如果PPP帧中的信息字段里面出现和标志字段一样的比特组合时，我们需要做的是使这些冒充的比特组合不要干扰我们正常的标志字段识别。在异步传输时PPP将转义符（类比ESC）定义为0x7D（01111101-8bit），并使用<mark>字节填充</mark><font size=6 color=tomato>【==重点==】</font>。在信息字段中出现的每一个等于0x7E（Flag）的地方，都转换为2字节序列（0x7D，0x5E）。同样的，若转义符也出现了，那么就需要将其转变成为 2 字节序列 (0x7D, 0x5D) 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变，如通常置为 0x03的控制字段 C，如果在信息字段中出现了值等于0x03的ASCII码，那么就需要将它转为（0x7D，0x23）
    - 至于同步传输时的  <mark>零比特填充</mark><font size=6 color=tomato>【==重点==】</font>，非常简单，就是在发送端，只要发现有 5 个连续 1，则立即填入一个 0。接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除。

2. PPP 协议的工作状态 
    - 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
    - PC 机向路由器发送一系列的 LCP(链路控制协议,Link Control Protocol。它是PPP协议的一个子集,在PPP通信中,发送端和接收端通过发送LCP包来确定那些在数据传输中的必要信息。) 分组（封装成多个 PPP 帧）。
    - 这些LCP分组及其收到的响应选择了一些将要使用的 PPP 参数，并进行网络层配置，NCP（网络控制协议）给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
    - 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

    可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。

    ![ppp协议状态图.PNG](http://7xkwr3.com1.z0.glb.clouddn.com/ppp协议状态图.PNG)
    
### 3.3 计算机通过适配器和局域网进行通信 

    【CPU和存储器{IP地址} 生成发送的数据，处理收到的数据】-并行通信->【适配器（网卡）{硬件地址} 把帧发送到局域网，从局域网接收帧】-串行通信->局域网

1. 为了通信的简便，以太网采取了两种重要的措施

    - 采用较为灵活的<mark>无连接的工作方式</mark>:不必先建立连接就可以直接发送数据、对发送的数据帧不进行编号，也不要求对方发回确认。这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的。 
    - 以太网发送的数据都使用曼彻斯特编码
    - p.s. <u>以太网提供的服务是不可靠的交付，即尽最大努力的交付</u>。当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做。<mark>差错的纠正由高层来决定</mark>。如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。  

2. CSMA/CD 【载波监听多点接入 / 碰撞检测】协议   

    本协议有以下要点：
    - “多点接入”表示许多计算机以多点接入的方式连接在一根总线上。
    - “载波监听”是指每一个站(总线上的计算机)在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。 
    - 总线上并没有什么“载波”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。
    - 使用本协议时一个站不可能同时进行发送和接收（但必须边发送边监听信道）
    
    对于碰撞检测
    - “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。
    - <u>当几个计算机同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）</u>。
    - <mark>当一个计算机检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个计算机同时在发送数据，表明产生了碰撞</mark>。
    - 所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”

    检测到碰撞后
    - 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
    - 每一个正在发送数据的站（计算机），一旦发现总线上出现了碰撞，就要<mark>立即停止发送</mark>，免得继续浪费网络资源，然后<mark>等待一段随机时间后</mark>再次发送。

    为什么要进行碰撞检测？
    - 由于电磁波在总线上的传播速率是有限的，当某个站监听到总线是空闲时，也可能总线并非真正是空闲的。 
    - A 向 B 发出的信息，要经过一定的时间后才能传送到 B。B 若在 A 发送的信息到达 B 之前发送自己的帧 (因为这时 B 的载波监听检测不到 A 所发送的信息)，则必然要在某个时间和 A 发送的帧发生碰撞。碰撞的结果是两个帧都变得无用。
    - 所以需要在发送期间进行碰撞检测，以检测冲突。

    争用期
    - 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 这种<u>发送的不确定性</u>使整个以太网的平均通信量远小于以太网的最高数据率。  
    - 最先发送数据帧的站，在发送数据帧后<mark>至多</mark>经过时间 <mark>2𝜏（两倍的端到端往返时延）</mark>就可知道发送的数据帧是否遭受了碰撞。
    - 以太网的端到端往返时延 2𝜏 称为<mark>争用期</mark>，或<mark>碰撞窗口</mark>。<u>经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞</u>。

    发生碰撞的站在停止发送数据后，要推迟（退避）一个<mark>随机时间</mark>才能再发送数据。--- 二进制指数类型退避算法
    - 基本退避时间取为争用期 2𝜏
    - 从整数集合[0, 1, ... , (2^k-1)]中随机地取出一个数，记为r。重传所需的时延就是 r 倍的基本退避时间。
    - 参数 k 按公式计算: k = Min[重传次数, 10]
    -当 k < = 10 时，参数 k 等于重传次数。当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。
    - 比如<font size=4 color=tomato>【=习题3-22=】</font>

    <u>争用期的长度</u>
    - <mark>10 Mbit/s </mark>以太网取 <mark>51.2 µs </mark>为争用期的长度。对于 10 Mbit/s 以太网，在争用期内可发送 <mark>512 bit</mark>，即<mark> 64 字节</mark>。
    - 这意味着：以太网在发送数据时，</mark>若前 64 字节没有发生冲突，则后续的数据就不会发生冲突</mark>。
    - 比如<font size=4 color=tomato>【=习题3-24=】</font>

    <u>最短有效帧长</u>
    - 如果发生冲突，就一定是在发送的前 64 字节之内。 
    - 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。
    - <mark>以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧</mark>，若发送的数据本身小于64字节，就需要加入填充字节。 
    - 比如<font size=4 color=tomato>【=习题3-20=】</font>

    信号在以太网三传播1km大约需要5µs，以太网上最大的端到端时延必须小于争用期的一半(即25.6µs)，这相当于以太网的最大端到端长度约为5km。实际上的以太网覆盖范围远远没有这样大。因此，实用的以太网都能在争用期51.2µs内检测到可能发生的碰撞。以太网的争用期确定为51.2µs，不仅考虑到以太网的端到端时延，而且还包括其他的许多因素，如存在的转发器所增加的时延，以及下面的强化碰撞的干扰信号的持续时间等。
    
    对于强化碰撞的概念。就是当发送数据的站一旦发现发生了碰撞时，除了立即停止发送数据外，还要再继续发送32比特或48比特的人为干扰信号(jamming signal)，以便让所有用户都知道现在已经发生了碰撞。对于10 Mb/s以太网，发送32（或48）比特只需要3.2（或4.8）µs。

    <mark>假设A站向B发送数据，从发送数据开始到发现碰撞并停止发送的时间间隔是TB。A站得知发生碰撞时发送的强化碰撞的干扰信号的持续时间是TJ。此时B站得知发生碰撞，也要发送干扰信号。<u>发生碰撞使A浪费时间为TB-TJ</u>，但整个信道被占用的时间<u>还要增加一个单程端到端的传播时延𝜏</u>,这是因为当一个站发送完最后一个比特时，这个比特还要在以太网上传播。因此</u>总线被占用的时间是TB-TJ-𝜏</u></mark>

    <mark>以太网还规定了帧间最小间隔为9.6µs，相当于96比特时间</mark>，为了使刚刚收到数据帧的站接受缓存来得及清理，做好接收下一帧的准备。

    综上，CSMA/CD协议的要点为
    - (1) 准备发送。但在发送之前，必须先检测信道。
    - (2) 检测信道。若检测到信道忙，则应不停地检测，一直等待信道转为空闲。若检测到信道空闲，并在 96 比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧。
    - (3) 检查碰撞。在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可能性：
        - ①发送成功：在争用期内一直未检测到碰撞。这个帧肯定能够发送成功。发送完毕后，其他什么也不做。然后回到 (1)。
        - ②发送失败：在争用期内检测到碰撞。这时立即停止发送数据，并按规定发送人为干扰信号。适配器接着就执行指数退避算法，等待 r 倍 512 比特时间后，返回到步骤 (2)，继续检测信道。但若重传达 16 次仍不能成功，则停止重传而向上报错。

3. 使用集线器的星形拓扑 

    目前以太网已发展为使用更便宜和更灵活的双绞线。采用双绞线的以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做集线器 (hub)。

    1990 年，IEEE 制定出星形以太网 10BASE-T 的标准 802.3i。10-速率为10Mbit/s，BASE-基带，T-双绞线

4. <mark>以太网的信道利用率</mark>

    多个站在以太网上同时工作就可能会发生碰撞。当发生碰撞时，信道资源实际上是被浪费了。因此，当扣除碰撞所造成的信道损失后，以太网总的信道利用率并不能达到 100%。
    
    参数 α 与利用率：假定发送帧需要的时间是 T0，帧长为 L (bit)，数据发送速率为 C (bit/s)，则帧的发送时间为  T0 = L/C (s)。要提高以太网的信道利用率，就必须减小 𝜏 与 T0 之比。𝜏 = l／c，其中l为信道长c为数据运动速率即数据率。在以太网中定义了参数 α，它是以太网单程端到端时延 𝜏 与帧的发送时间 T0 之比：α = 𝜏/T0
    - α → 0，表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高。
    - α 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。 
    - <u>为提高利用率，以太网的参数a的值应当尽可能小些</u>。

    <mark>对以太网参数 α 的要求是：</mark>
    - 当数据率一定时，以太网的连线的长度受到限制，否则 𝜏 的数值会太大。
    - 以太网的帧长不能太短，否则 T0 的值会太小，使 α 值太大。 

    <mark>信道利用率的最大值 Smax </mark>
    - 发送一帧占用线路的时间是 T0 - 𝜏，而帧本身的发送时间是 T0。于是我们可计算出理想情况下的极限信道利用率 Smax 为： Smax = T0/(T0-𝜏) = 1/(1-α)
    - 只有当参数 a 远小于 1 才能得到尽可能高的极限信道利用率。
    - 据统计，当以太网的利用率达到 30%时就已经处于重载的情况。很多的网络容量被网上的碰撞消耗掉了。

5. 以太网的 MAC 层

    mac是物理地址，不是逻辑地址
    有逻辑地址不一定能找到mac地址，故这两个要映射出来。

    以太网V2的 MAC 帧格式-最常用，为了达到比特同步，在传输媒体上实际传送的要比 MAC 帧还多 8 个字节
    ```
    | MAC帧前插入8字节（硬件生成），包括7字节前同步码(1010....1010)和1字节帧开始定界符(10101011-8bit) | 以太网MAC帧 |
    ```
    以太网MAC帧由5个字段组成
    ```
    | 目的地址 6BYTE | 源地址 6BYTE | 类型 2BYTE「类型字段用来标志上一层使用的是什么协议，以便把收到的 MAC 帧的数据上交给上一层的这个协议。 」 | 
    数据字段 46-1500BYTE 数据字段的正式名称是 MAC 客户数据字段。最小长度 64 字节 - 18 字节的首部和尾部  =  数据字段的最小长度（46字节）| FCS 4BYTE|

    note：当数据字段的长度小于 46 字节时，应在数据字段的后面加入整数字节的填充字段，以保证以太网的 MAC 帧长不小于 64 字节。 
    ```
    对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。 

### 3.4 拓展的以太网

- 在物理层扩展以太网-使用光纤扩展或使用集线器扩展，<u>尽量用光纤</u>
    - 光纤：很容易使主机和几公里以外的集线器相连接。
    - 集线器：碰撞域增大了，但总的吞吐量并未提高。如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。   
- 在数据链路层扩展以太网

    现在使用以太网交换机。1990 年问世的交换式集线器 (switching hub) 可明显地提高以太网的性能，常称为以太网交换机 (switch) 或第二层交换机 (L2 switch)，强调这种交换机工作在数据链路层。
    
    交换机自学习和转发帧的步骤归纳 比如<font size=4 color=tomato>【=习题3-33=】</font>
    - 交换机收到一帧后先进行自学习。查找交换表中与收到帧的源地址有无相匹配的项目。
        - 如没有，就在交换表中增加一个项目（源地址、进入的接口和有效时间）。
        - 如有，则把原有的项目进行更新（进入的接口或有效时间）。
    - 转发帧。查找交换表中与收到帧的目的地址有无相匹配的项目。
        - 如没有，则向所有其他接口（进入的接口除外）转发。
        - 如有，则按交换表中给出的接口进行转发。
        - 若交换表中给出的接口就是该帧进入交换机的接口，则应丢弃这个帧（因为这时不需要经过交换机进行转发）。
- 虚拟局域网vlan（实验一做的就是vlan划分）

    利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)。

### 3.5 高速以太网

在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议。

### 3.6 个人兴趣：PPPoE

PPPoE (PPP over Ethernet) 的意思是“在以太网上运行 PPP”，它把 PPP 协议与以太网协议结合起来 —— 将 PPP 帧再封装到以太网中来传输。

现在的光纤宽带接入 FTTx(新一代的光纤用户接入网) 都要使用 PPPoE 的方式进行接入。在 PPPoE 弹出的窗口中键入在网络运营商购买的用户名和密码，就可以进行宽带上网了。

利用 ADSL 进行宽带上网时，从用户个人电脑到家中的 ADSL 调制解调器之间，也是使用 RJ-45 和 5 类线（即以太网使用的网线）进行连接的，并且也是使用 PPPoE 弹出的窗口进行拨号连接的。

