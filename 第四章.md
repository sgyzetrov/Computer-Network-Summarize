## 第四章 网络层

### 4.1 网络层提供的两种服务

在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？ 

目前给出的答案：网络提供数据报服务
- 网络层向上只提供简单灵活的、<mark>无连接的、尽最大努力交付</mark>的<mark>数据报服务</mark>。
- 网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
- <mark>网络层不提供服务质量的承诺</mark>。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。

### 4.2 网络层协议IP

1. 虚拟互连网络 
    
    当中继系统是转发器或网桥（交换机）时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。 网络互连都是指用路由器进行网络互连和路由选择。
   
    虚拟互连网络的意义
    - <mark>所谓虚拟互连网络也就是逻辑互连网络，利用 IP 协议就可以使性能各异、物理异构的网络从用户看起来好像是一个统一的网络</mark>。
    - 使用 IP 协议的虚拟互连网络可简称为<mark> IP 网</mark>
    - 使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。
    - <mark>如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)</mark>。

2. 分类的 IP 地址

    在 TCP/IP 体系中，IP 地址是一个最基本的概念

    IP 地址及其表示方法
    - 我们把整个因特网看成为一个单一的、抽象的网络。
    - IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是唯一的<mark> 32 </mark>位的标识符。
    - 分类 IP 地址 
        - 将IP地址划分为若干个固定类。
        - 每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。
        - 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
        - 由此可见，一个 IP 地址在整个互联网范围内是唯一的。
        - 两级的 IP 地址结构：[网络号-主机号]：32位
            - A类地址：8[net-id]-24[host-id]---1-126,数字0和 127不作为A类地址，数字127保留给内部回送函数，而数字0则表示该地址是本地宿主机，不能传送。
                A 类地址的网络号字段 net-id 为 1 字节
                A 类地址的主机号字段 host-id 为 3 字节
            - B类地址：16-16---128-191
                B 类地址的网络号字段 net-id 为 2 字节
                B 类地址的主机号字段 host-id 为 2 字节
            - C类地址：24-8----192-223
                C 类地址的网络号字段 net-id 为 3 字节
                C 类地址的主机号字段 host-id 为 1 字节
            - D E类地址：D 类地址是多播地址；E 类地址保留为今后使用
        - 点分十进制记法：机器中存放的 IP 地址是 32 位二进制代码，每 8 位为一组。将每 8 位的二进制数转换为十进制数就变成熟悉的如128.11.3.31之类的了
        - 常见的三种 IP 地址的指派范围 

        | 网络类别 | 最大可指派的网络数 | 第一个可指派的网络号 | 最后一个可指派的网络号 | 每个网络中最大主机数 |
        |---|:---:|:---:|:---:|:---:|
        | A | 126 (2^7 – 2)| 1 | 126 | 16777214|
        | B | 16383 (2^14 – 1) | 128.1| 191.255 | 65534 |
        | C | 2097151 (2^21 – 1) | 192.0.1 | 223.255.255 | 254 |

        - 一般不使用的特殊的 IP 地址

        | 网络号 | 主机号 | 源地址使用 | 目的地址使用 | 代表的意思 |
        |---|:---:|:---:|:---:|:---:|
        | 0 | 0 | 可以 | 不可 | 在本网络上的本主机（见6.6节DHCP协议）|
        | 0 | host-id | 可以 | 不可 | 在本网络上的某台主机host-id |
        | 全1 | 全1 | 不可 | 可以 | 只在本网络上进行广播（各路由器均不转发）|
        | net-id | 全1 | 不可 | 可以 | 对net-id上的所有主机进行广播 |
        | 127 | 非全0或全1的任何数 | 可以 | 不可 | 用作本地软件环回测试之用<br>ping 127.0.0.1测试本机TCP／IP是否正常 |
    - IP 地址的一些重要特点 
        - IP 地址是一种分等级的地址结构。
            - IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理
            - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。 
        - 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。
            - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机 (multihomed host)。
            - <u>由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址</u>。 
        - 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。
        - 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。
    - <mark>IP 地址与硬件地址</mark>
        ```
        TCP 报文：                               | 首部 | 应用层数据 |
        IP 数据报：                 | 首部「IP地址」| 首部 | 应用层数据 |
        MAC 帧：  | 首部「硬件地址」  | 首部「IP地址」| 首部 | 应用层数据 | 尾部 |
        ```
    - 地址解析协议 ARP 
        - 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址
        - 如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。也就是大网络通信的时候有没有mac地址无所谓，有IP就能从ARP来得到mac地址。
        - 本地广播 ARP 请求的时候路由器不转发ARP请求，路由器本身就是割断广播域的，因为广播域太大会影响性能。这也是为什么路由器不会转发ARP请求。若转发了这两个广播域就连起来了。那路由器就无用处了。网络与网络相连，靠的是路由器。
        - <mark>ARP 高速缓存的作用：存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量，提高速度。</mark>
    - <mark>不直接使用硬件地址进行通信的原因</mark>
        - 不是一个局域网无法构造mac帧，只有把目标IP告诉路由器再由路由器进行转发
        - 全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。
        - 因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。
    - <mark>IP 数据报的格式 </mark>
        - 一个 IP 数据报由首部和数据两部分组成。
        - 首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。 
        - IP数据报首部最开始由版本（4 位，目前的 IP 协议版本号为 4 ，即 IPv4）-首部长度（4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节）-区分服务-总长度-。。。组成，其中“总长度”部分占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元 MTU。 
        - 接下去是标识(identification)，占 16 位，它是一个计数器，用来产生 IP 数据报的标识。 
        - <mark>然后是标志位(flag)，占3位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF = 0 时才允许分片</mark>。
        - <mark>接着是片偏移—— 占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。</mark>
        - <mark>【例4-1】 IP 数据报分片 </mark>
            ```
            一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。因固定首部长度为 20 字节，因此每个数据报片的数据部分长度不能超过 1400 字节。于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。「（3820-20[首部长度]）／ （1420-20[首部长度]）≈ 2.x 故分三个数据报片」
            
            原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值。
            
            一个完整3820数据报，减去20首部，剩3800字节数据部分，从0字节开始到3799结束。要分为3块，那就从0、1400、2800字节处分割
            数据报片1： | 首部0 | 3800字节中的0-1399字节 | -->偏移：0/8=0
            数据报片2： | 首部1 | 3800字节中的1400-2799字节 | -->偏移：1400/8=175
            数据报片3： | 首部2 | 3800字节中的2800-3799字节 | -->偏移：2800/8=350

            最终IP 数据报首部中与分片有关的字段中的数值：

                     总长  标识  MF DF 片偏移
            原始数据报 3820 12345 0  0    0
            数据报片1 1420 12345  1  0     0
            数据报片2 1420 12345  1  0    175
            数据报片3 1020 12345  0  0    350
            ```
        - 接着是生存时间，占8 位，记为 TTL (Time To Live)没有它网络性能会下降。然后是协议，占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程
        - 然后是首部检验和checksum，占16 位，只检验数据报的首部，不检验数据部分。不采用 CRC 检验码而采用简单的16 位二进制反码求和算法。 
            - 简单来说该算法的思路就是在发送端把数据报的首部分为一个个字，也就是16位，然后16 16 16像堆积木一样从上到下对齐，此时校验和的16位也在这一层层中，只不过是全0，然后反码算数运算求和，得到16位结果，然后再取反码放入校验和的16位处。
            - 接收端收到后同样搭积木，反码算数运算求和，得到16位结果，然后再取反码。若结果为 0, 则保留；否则，丢弃该数据报
            - 反码算数运算求和: 0和0相加是0但要产生一个进位1，0和1相加是1，1和1相加是0。若最高位相加后产生进位，则最后得到的结果要加1。
        - 源地址和目的地址都各占 4 字节
        - 可选字段：选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目，很少被使用
    - 路由表没有给分组指明到某个网络的完整路径。路由表指出的是下一跳路由器。在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。所以路由表路由表路由表...组成了最短路径(无向图)

3. 划分子网和构造超网
    
    由于两级的 IP 地址不够灵活、IP 地址空间的利用率有时很低等原因 ，从 1985 年起在 IP 地址中又增加了一个“子网号字段”，使两级的 IP 地址变成为三级的 IP 地址。这种做法叫作划分子网 (subnetting) 。划分子网已成为互联网的正式标准协议。

    划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。

    凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。最后就将 IP 数据报直接交付目的主机。 

    当没有划分子网时，IP 地址是两级结构。划分子网后 IP 地址就变成了三级结构。划分子网只是把 IP 地址的主机号 host-id 这部分进行再划分，而不改变 IP 地址原来的网络号 net-id。 

    对内为带子网的三级结构，对外仍为两层结构。

    从一个 IP 数据报的首部并<u>无法判断</u>源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码(subnet mask)可以找出 IP 地址中的子网部分。  

    子网掩码规则：
    - 子网掩码长度＝32位
    - 某位＝1：IP地址中的对应位为网络号和子网号
    - 某位＝0：IP地址中的对应位为主机号
    - 比如一个两级IP地址：145.13.3.10，其中145.13为网络号，3.10为主机号
        - 若变为三级地址：145.13仍为网络号，3则变为子网号，最后的10为主机号，145.13.3称为子网号为3的网络的网络号
        - 三级IP地址的子网掩码按照规则置1处表示网络号或子网号，故为11111111(8位) 11111111(8位) 11111111(8位) 00000000(8位)，前面24位都是1，对应145.13.3，所以子网掩码默认255.255.255.0是这么来的
    - <mark>(IP 地址) AND (子网掩码) =网络地址</mark> 也就是比如一个三级地址143.13.3.10与255.255.255.0逐位进行AND运算，最终得到的就是子网的网络地址。
        - A类地址对应的子网掩码：255.0.0.0
        - B类地址对应的子网掩码：255.255.0.0
        - C类地址对应的子网掩码：255.255.255.0
        - 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。
        - 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
        - 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

    子网划分方法
    - 有固定长度子网和变长子网两种子网划分方法。
    - 在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的。
    - 现在全1和全0的子网号也可以使用了。
    - 划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。
    - 另：默认网关的最后不要设为255，255是广播域，应设置为254
    
    <font size=6 color=tomato>【==笔记本上有一道ppt里面没有的例题，是关于一个C类地址有5个地点每个地点30台机子问子网划的==】</font>
    
    无分类编址 CIDR
    - 划分子网在一定程度上缓解了互联网在发展中遇到的困难。但整个 IPv4 的地址空间最终将全部耗尽。
    - CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。
        - CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。
        - IP 地址从三级编址（使用子网掩码）又回到了两级编址。  
            ```
            | 网络前缀 | 主机号 | --32位
            ```
        - CIDR 使用“斜线记法”(slash notation)，它又称为 CIDR 记法，即在 IP 地址面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24
        - CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR 地址块”。
        - 128.14.32.0/20 表示的地址块共有 2^12 个地址（因为斜线后面的 20 是网络前缀的位数而整个位数是32不变，所以这个地址的主机号是32-20 = 12 位）。
            - 这个地址块的起始地址是 128.14.32.0。
            - 在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。
            - 128.14.32.0/20 地址块的最小地址：128.14.32.0-->因为【10000000 00001110 0010 】(20位) 0000 00000000(32-20=12位)
            - 128.14.32.0/20 地址块的最大地址：128.14.47.255-->因为【10000000 00001110 0010 】(20位) 1111 11111111(32-20=12位)
            - 上面的这个最小和最大地址是全 0 和全 1 的，但全 0 和全 1 的主机号地址一般不使用。
    - 一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由
    - 路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。路由聚合也称为构成超网 (supernetting)。
    - CIDR 虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）。对于 /20 地址块，它的掩码是 20 个连续的 1。 斜线记法中的数字就是掩码中1的个数。    
    - CIDR 记法的其他形式 
        - 10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略。
        - 10.0.0.0/10 隐含地指出 IP 地址 10.0.0.0 的掩码是 255.192.0.0。此掩码可表示为：11111111(255) 11000000(192) 00000000 00000000--->掩码中有 10 个连续的 1
        - 网络前缀的后面加一个星号 * 的表示方法，如 00001010 00*，在星号 * 之前是网络前缀，而星号 * 表示 IP 地址中的主机号，可以是任意值。
    - 构成超网
        - 前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C  类地址（超过23位比如24位长度的前缀就只包含1个C类了，25位的包含1/2个C类...）。这些 C 类地址合起来就构成了超网。
        - <mark>CIDR 地址块中的地址数一定是 2 的整数次幂</mark>。
        - 网络前缀越短，其地址块所包含的地址数就越多。<u>而在三级结构的IP地址中，划分子网是使网络前缀变长</u>。
        - CIDR 的一个好处是：可以更加有效地分配 IPv4 的地址空间，可根据客户的需要分配适当大小的 CIDR 地址块。 
4. 互联网的路由选择协议 
    - 内部网关协议 RIP
        - RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 
        - “距离”的定义
            - 从一个路由器到直接连接的网络的距离定义为 1
            - 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1
            - RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1
            - 这里的“距离”实际上指的是“最短距离”，RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”
            - RIP 允许一条路径最多只能包含 15 个路由器。
            - “距离”的最大值为 16 时即相当于不可达。可见 RIP 只适用于小型互联网。
            - RIP 不能在两个网络之间同时使用多条路由。
            - RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。 
        - 路由表的建立
            - 路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）。它的路由表是空的。
            - 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
            - RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。 
        - 距离向量算法<font size=6 color=tomato>【==别硬背，结合题目理解==】</font>
            - 距离向量算法中涉及到替换的问题：
                - 拿到信息后做一个副本。接着把所有目的地址转换成发送方的路由器号，然后距离+1
                - 接着，若发现拿到的距离虽然是新的，但并不比原来的短，<mark>则一样更新</mark>
        - 特点：好消息传播得快，坏消息传播得慢。看一下ppt 190前后的例子
    - 内部网关协议 OSPF--开放最短路径优先协议
        - 优点是收敛快，向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法，就相当于广播。
        - 为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫作区域。
        - 每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。
        - 区域也不能太大，在一个区域内的路由器最好不超过 200 个。  
    - 外部网关协议 BGP
    - <mark>路由表是根据理由选择算法得出的，而转发表是从路由表得出的</mark>